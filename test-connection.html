<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Connection Test</title>
</head>
<body>
    <h1>WebRTC Connection Test</h1>
    <div id="status">Initializing...</div>
    <button id="createBtn">Create Call</button>
    <button id="joinBtn">Join Call</button>
    <input type="text" id="codeInput" placeholder="Enter call code">
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const status = document.getElementById('status');
        const createBtn = document.getElementById('createBtn');
        const joinBtn = document.getElementById('joinBtn');
        const codeInput = document.getElementById('codeInput');
        
        let socket;
        let localStream;
        let rtcPeerConnection;
        let callCode;
        
        // Initialize socket connection
        function initSocket() {
            socket = io('http://localhost:3000');
            
            socket.on('connect', () => {
                status.textContent = 'Socket connected: ' + socket.id;
                console.log('Socket connected:', socket.id);
            });
            
            socket.on('disconnect', () => {
                status.textContent = 'Socket disconnected';
                console.log('Socket disconnected');
            });
            
            socket.on('ready', (code) => {
                console.log('Receiver ready:', code);
                status.textContent = 'Receiver ready, creating offer...';
                createOffer();
            });
            
            socket.on('offer', (param) => {
                console.log('Received offer:', param);
                status.textContent = 'Received offer, creating answer...';
                handleOffer(param);
            });
            
            socket.on('answer', (event) => {
                console.log('Received answer:', event);
                status.textContent = 'Received answer, connection should be established';
                handleAnswer(event);
            });
            
            socket.on('candidate', (event) => {
                console.log('Received ICE candidate:', event);
                handleCandidate(event);
            });
        }
        
        // Create call
        createBtn.addEventListener('click', async () => {
            try {
                status.textContent = 'Creating call...';
                
                // Get user media
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                console.log('Got local stream');
                
                // Create call
                socket.emit('create', (code) => {
                    callCode = code;
                    status.textContent = 'Call created with code: ' + code;
                    console.log('Call created:', code);
                });
                
            } catch (error) {
                console.error('Error creating call:', error);
                status.textContent = 'Error: ' + error.message;
            }
        });
        
        // Join call
        joinBtn.addEventListener('click', async () => {
            try {
                const code = codeInput.value.trim();
                if (!code) {
                    status.textContent = 'Please enter a call code';
                    return;
                }
                
                status.textContent = 'Joining call...';
                
                // Get user media
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                console.log('Got local stream');
                
                // Join call
                socket.emit('join', code);
                status.textContent = 'Joined call, waiting for connection...';
                
            } catch (error) {
                console.error('Error joining call:', error);
                status.textContent = 'Error: ' + error.message;
            }
        });
        
        function createPeerConnection() {
            rtcPeerConnection = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.services.mozilla.com' },
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            });
            
            rtcPeerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('Sending ICE candidate');
                    socket.emit('candidate', {
                        type: 'candidate',
                        label: event.candidate.sdpMLineIndex,
                        id: event.candidate.sdpMid,
                        candidate: event.candidate.candidate,
                        sendTo: callCode // This might need to be adjusted
                    });
                }
            };
            
            rtcPeerConnection.ontrack = (event) => {
                console.log('Received remote track:', event.track.kind);
                status.textContent = 'Audio connection established!';
            };
            
            // Add local stream
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    rtcPeerConnection.addTrack(track, localStream);
                });
            }
        }
        
        async function createOffer() {
            createPeerConnection();
            
            try {
                const offer = await rtcPeerConnection.createOffer({ offerToReceiveAudio: 1 });
                await rtcPeerConnection.setLocalDescription(offer);
                
                socket.emit('offer', {
                    type: 'offer',
                    sdp: offer,
                    receiver: callCode
                });
                
                console.log('Offer sent');
            } catch (error) {
                console.error('Error creating offer:', error);
            }
        }
        
        async function handleOffer(param) {
            createPeerConnection();
            
            try {
                await rtcPeerConnection.setRemoteDescription(new RTCSessionDescription(param.event));
                const answer = await rtcPeerConnection.createAnswer();
                await rtcPeerConnection.setLocalDescription(answer);
                
                socket.emit('answer', {
                    type: 'answer',
                    sdp: answer,
                    caller: param.caller
                });
                
                console.log('Answer sent');
            } catch (error) {
                console.error('Error handling offer:', error);
            }
        }
        
        async function handleAnswer(event) {
            try {
                await rtcPeerConnection.setRemoteDescription(new RTCSessionDescription(event));
                console.log('Answer processed');
            } catch (error) {
                console.error('Error handling answer:', error);
            }
        }
        
        async function handleCandidate(event) {
            try {
                const candidate = new RTCIceCandidate({
                    sdpMLineIndex: event.label,
                    candidate: event.candidate
                });
                await rtcPeerConnection.addIceCandidate(candidate);
                console.log('ICE candidate added');
            } catch (error) {
                console.error('Error adding ICE candidate:', error);
            }
        }
        
        // Initialize
        initSocket();
    </script>
</body>
</html>
